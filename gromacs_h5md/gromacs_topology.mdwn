GROMACS Topology
----------------

### Objective

This module defines storage of GROMACS-specific molecular topology information
including molecule types, molecule blocks, particle properties with lookup tables,
and residue information. This module is designed for internal GROMACS use to enable
complete reconstruction of GROMACS topology data structures from H5MD files,
facilitating trajectory continuation, analysis with GROMACS tools, and data exchange
within the GROMACS ecosystem.

### Module name and version

The name of this module is `gromacs_topology`. The module version is 0.1.0.

**Note**: This module is marked as experimental (major version = 0) per semantic
versioning rules. Breaking changes may occur until the module is stabilized at
version 1.0.0.

### Module location

All data for this module is stored in the `/h5md/modules/gromacs_topology` group.

### Data structure

    h5md
     \-- modules
          \-- gromacs_topology
               +-- version: Integer[2]
               +-- system_name: String[]
               +-- molecule_block_names: String[M]
               +-- molecule_block_counts: Integer[M]
               \-- <molecule_type_1>
               |    +-- particle_count: Integer[]
               |    +-- residue_count: Integer[]
               |    \-- id: Integer[N]
               |    \-- mass: Float[N]
               |         +-- unit: String[]
               |    \-- charge: Float[N]
               |         +-- unit: String[]
               |    \-- species: Integer[N]
               |    \-- particle_name: Integer[N]
               |    \-- particle_name_table: String[P]
               |    \-- residue_id: Integer[N]
               |    \-- sequence: Integer[N]
               |    \-- residue_name: Integer[N]
               |    \-- residue_name_table: String[R]
               |    \-- (posres_xA: Float[N][3])
               |    \-- (posres_xB: Float[N][3])
               \-- <molecule_type_2>
               |    \-- ...
               \-- ...

### Module-level attributes

`version`
:   A required attribute of `Integer` datatype and simple dataspace of rank 1 and
    size 2 that contains the major and minor version numbers of this module
    (`[0, 1]` for the current experimental version).

`system_name`
:   A required attribute of fixed-length string datatype and scalar dataspace
    that stores the name of the molecular system.

`molecule_block_names`
:   A required attribute of fixed-length string datatype and simple dataspace
    of rank 1 and size M (number of molecule types) that stores the names of
    each molecule type in the system. These names correspond to the subgroup
    names within `gromacs_topology/`.

`molecule_block_counts`
:   A required attribute of `Integer` datatype and simple dataspace of rank 1
    and size M that stores the number of molecules of each type present in the
    system. The order matches `molecule_block_names`.

### Molecule type groups

Each molecule type in the system is stored in a subgroup named according to
the molecule type name (as listed in `molecule_block_names`). Each molecule
type group contains complete topology information for one molecule of that type.

#### Molecule-level attributes

`particle_count`
:   A required attribute of `Integer` datatype and scalar dataspace that stores
    the number of particles (atoms) in one molecule of this type.

`residue_count`
:   A required attribute of `Integer` datatype and scalar dataspace that stores
    the number of residues in one molecule of this type.

### Particle properties

All particle property datasets have rank 1 and size N, where N is the number
of particles in one molecule of this type.

`id`
:   A required dataset of `Integer` datatype that stores the unique particle
    identifier (1-based indexing) for each particle within the molecule type.
    These identifiers are used to map particles to their properties and to
    reference particles in connectivity information.

`mass`
:   A required dataset of `Float` datatype that stores the mass of each particle.
    Must include a `unit` attribute (typically "u" for atomic mass units).

`charge`
:   A required dataset of `Float` datatype that stores the partial charge of
    each particle. Must include a `unit` attribute (typically "e" for elementary
    charge units).

`species`
:   A required dataset of `Integer` datatype that stores the atomic number
    (chemical element) of each particle. For unified atoms or coarse-grained
    beads, this represents the primary element or may use a special encoding.

`particle_name`
:   A required dataset of `Integer` datatype that stores indices into the
    `particle_name_table` lookup table. Each value is an index (0-based)
    pointing to the corresponding particle name string.

`particle_name_table`
:   A required dataset of fixed-length string datatype and rank 1 that stores
    unique particle names (e.g., "CA", "CB", "N", "O", "HG1"). This lookup table
    approach efficiently stores repeated particle names by storing each unique
    name only once. Particle names in this table are GROMACS atom names as they
    appear in topology files.

### Residue information

`residue_id`
:   A required dataset of `Integer` datatype that stores the residue identifier
    (1-based indexing) for each particle. Multiple particles belonging to the
    same residue have the same residue identifier.

`sequence`
:   A required dataset of `Integer` datatype that stores indices into the
    `residue_name_table` for the residue sequence. This dataset has one entry
    per particle, mapping each particle to its residue name via the lookup table.

`residue_name`
:   A required dataset of `Integer` datatype that stores indices into the
    `residue_name_table` for each particle. This is functionally equivalent to
    `sequence` and maps particles to residue names.

`residue_name_table`
:   A required dataset of fixed-length string datatype and rank 1 that stores
    unique residue names (e.g., "ALA", "GLY", "HOH", "POPC"). This lookup table
    efficiently stores repeated residue names. Residue names in this table are
    GROMACS residue names as they appear in topology files.

### Position restraints (optional)

`posres_xA`
:   An optional dataset of `Float` datatype and shape [N][3] that stores position
    restraint reference coordinates for topology A (for free energy calculations).
    Each row contains the x, y, z coordinates of the restraint position for the
    corresponding particle. Coordinates are typically in nm.

`posres_xB`
:   An optional dataset of `Float` datatype and shape [N][3] that stores position
    restraint reference coordinates for topology B (for free energy calculations).
    Structure is identical to `posres_xA`.

### Lookup table indexing

The use of lookup tables (`particle_name_table` and `residue_name_table`) provides
several advantages:

1. **Storage efficiency**: Common names like "HOH", "CA", "O" appear only once
   regardless of how many particles share that name.

2. **Read efficiency**: Minimizes string comparison operations during data access.

3. **Compatibility**: Matches GROMACS internal data structures.

**Example**: For a water molecule (3 atoms):
```
particle_name = [0, 1, 1]
particle_name_table = ["OW", "HW"]
```
This encoding indicates: first atom is "OW", second and third atoms are "HW".

### Relation to core H5MD elements

This module complements but does not replace core H5MD particle data:

- Core H5MD stores trajectory data (positions, velocities, forces) in
  `/particles/<group>/`
- This module stores static molecular topology in `/h5md/modules/gromacs_topology/`
- The `id` dataset in this module may correspond to particle identifiers used
  in connectivity information
- Species information may overlap with core H5MD `species` element

### Relation to connectivity

Bond connectivity information is stored separately in the core H5MD
`/connectivity` group (or enhanced connectivity module). The particle identifiers
in connectivity bond lists correspond to the global particle numbering scheme,
which can be reconstructed from the molecule block structure:

- Molecule type 1: atoms 1 to N₁
- Molecule type 2: atoms (N₁+1) to (N₁+N₂)
- etc.

Where multiple molecules of the same type exist (as specified by
`molecule_block_counts`), particles are numbered sequentially for each molecule
instance.

### Use with GROMACS

**Writing**: GROMACS mdrun automatically populates this module when writing
H5MD trajectory files if topology information is available.

**Reading**: GROMACS analysis tools can reconstruct the full topology from this
module, enabling:
- Proper atom/residue identification
- Group selections by atom/residue names
- Free energy analysis with position restraints
- Trajectory continuation

### Implementation notes

**Molecule blocks vs. particle groups**: GROMACS distinguishes between:
- **Molecule types** (unique molecular structures): stored as subgroups in this module
- **Molecule blocks** (counts of each type): stored in `molecule_block_counts`
- **Particle groups** (trajectory data): stored in core H5MD `/particles/`

The total number of atoms is: sum(molecule_block_counts[i] × particle_count[i])

**Virtual sites**: Virtual sites (dummy atoms) are included in the particle
count and have entries in all particle property datasets. They can be identified
by their mass (typically zero) or particle names.

**Free energy perturbation**: Position restraint datasets (`posres_xA`, `posres_xB`)
support dual-topology free energy calculations. When only single topology is used,
only `posres_xA` may be present, or both may be omitted.

### Compatibility with other modules

This module is complementary to:

- **topology module** (proposed): Provides subset of functionality with broader
  software compatibility. The `gromacs_topology` module includes GROMACS-specific
  details not covered by the general topology module.

- **connectivity module**: Bond connectivity stored separately in `/connectivity`
  uses global particle numbering derived from molecule block structure.

- **units module**: Required for proper interpretation of `mass` and `charge`
  units.

### Validation

Valid `gromacs_topology` modules must satisfy:

1. Module version attribute present: `[0, 1]`
2. `system_name` attribute present
3. `molecule_block_names` and `molecule_block_counts` arrays have equal length
4. Each name in `molecule_block_names` has corresponding subgroup
5. Each molecule type subgroup has required attributes and datasets
6. Lookup table indices in `particle_name` are valid (< size of `particle_name_table`)
7. Lookup table indices in `residue_name` and `sequence` are valid
8. All particle property datasets have size equal to `particle_count`
9. Residue IDs are consistent (all particles with same ID have same residue name)

### Example structure

For a system with 1 alanine dipeptide and 298 water molecules:

```
h5md/modules/gromacs_topology
  version: [0, 1]
  system_name: "Alanine in water"
  molecule_block_names: ["Alanine_dipeptide", "SOL"]
  molecule_block_counts: [1, 298]

  Alanine_dipeptide/
    particle_count: 22
    residue_count: 3
    id: [1, 2, 3, ..., 22]
    mass: [14.007, 1.008, 12.011, ...]
      unit: "u"
    charge: [-0.4157, 0.2719, 0.5973, ...]
      unit: "e"
    species: [7, 1, 6, ...]
    particle_name: [0, 1, 2, 3, ...]
    particle_name_table: ["N", "H", "CA", "HA", "CB", ...]
    residue_id: [1, 1, 1, 1, 1, 2, 2, 2, ...]
    sequence: [0, 0, 0, 0, 0, 1, 1, 1, ...]
    residue_name: [0, 0, 0, 0, 0, 1, 1, 1, ...]
    residue_name_table: ["ACE", "ALA", "NME"]

  SOL/
    particle_count: 3
    residue_count: 1
    id: [1, 2, 3]
    mass: [15.9994, 1.008, 1.008]
      unit: "u"
    charge: [-0.834, 0.417, 0.417]
      unit: "e"
    species: [8, 1, 1]
    particle_name: [0, 1, 1]
    particle_name_table: ["OW", "HW1"]
    residue_id: [1, 1, 1]
    sequence: [0, 0, 0]
    residue_name: [0, 0, 0]
    residue_name_table: ["SOL"]
```

Total atoms in system: 1 × 22 + 298 × 3 = 916 atoms

### Future extensions

Potential additions to future versions:

1. **Force field information**: Store GROMACS-specific force field parameters
   (consider using general `forcefield` module instead)

2. **Exclusions and pairs**: Store 1-4 interactions and exclusion lists

3. **Virtual site definitions**: Store virtual site construction parameters

4. **Free energy lambda states**: Store λ-state specific parameters

5. **Molecule type metadata**: Residue bonding information, chain identifiers

Changes that break file structure compatibility will increment major version number.

### References

- GROMACS documentation: https://www.gromacs.org
- GROMACS H5MD implementation: `src/gromacs/fileio/h5md/` in GROMACS source code
- H5MD specification: https://www.nongnu.org/h5md/

### Implementation

This module is implemented in GROMACS 2026.0 and later. The reference implementation
is found in:
- `src/gromacs/fileio/h5md/h5md.cpp` (setup and integration)
- `src/gromacs/fileio/h5md/h5md_topologyutils.cpp` (topology writing utilities)

### Authors - Attributed from what I found in GROMACS code. 

- Petter Johansson
- Yang Zhang 
